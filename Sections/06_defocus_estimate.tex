\section{Defocus estimate} \label{sec:defocus_estimate}

\subsection{Objectives}

There are two main objectives. First, create the aligned, optionally bead-erased, weighted stacks. Weighted refers to the per-view weighting applied by {\emClarity} to take into account the frequency dependent drop in SNR due to radiation damage, an isotropic drop in SNR due to increased thickness with the tilt-angle causing inelastic scattering losses and optionally also for the cosine dose-scheme, also referred as Saxton scheme. These stacks will be then used to compute the tomograms at later stages. The second objective is to estimate the defocus of each view of the stack (two defoci and the astigmatism angle, per view).

\subsection{Parameters}

% table
\input{Figures_Tables/06_parameters}

\subsection{Run}

The \code{ctf estimate} routine has the following signature:
\begin{lstlisting}
>> emClarity ctf estimate <param> <prefix>
\end{lstlisting}
\code{<param>} is the name of the parameter file (e.g. \code{param\_ctf.m}), and \code{<prefix>} is the base-name of the tilt-series in \code{<projectDir>/fixedStacks} you wish to process.

For example, to run \code{ctf estimate} on the first tilt-series of the tutorial:
\begin{lstlisting}
>> emClarity ctf estimate param_ctf.m tilt1
\end{lstlisting}

If you have many tilt-series and you don't want to run all of them individually, you can do the following. This will select every available stack to emClarity and run \code{ctf estimate} on each one of them.
\begin{lstlisting}
#!/bin/bash
for stack in fixedStacks/*.fixed; do
    prefix=${stack#fixedStacks}
    emClarity ctf estimate param_ctf.m ${prefix%.fixed}
done
\end{lstlisting}

If you didn't remove the bad images by now, \code{ctf estimate} can remove images from the stack. For instance, to remove the first view of tilt1, run:
\begin{lstlisting}
>> emClarity ctf estimate param_ctf.m tilt1 1
\end{lstlisting}

and to remove the first and last view of tilt11, run:
\begin{lstlisting}
>> emClarity ctf estimate param_ctf.m tilt11 [1,41]
\end{lstlisting}

\begin{note}You should remove the first view from the tilt-series tilt1 to tilt10, and the first and last views from tilt11 and tilt12.
\end{note}

\subsection{Outputs}

You should make sure the tilt-series ``looks aligned'' and the average defocus (at the tilt axis) was correctly estimated. The best way to check:
\begin{enumerate}
    \item Open \code{aliStacks/<prefix>\_ali1.fixed} and go through the views. The views should be aligned to the tilt-axis, which must be parallel to the Y axis (so vertical if you use {\threedmod}). If an \code{*.erase} file was available for this tilt-series, the beads should be removed.
    \item Open \code{fixedStacks/ctf/<prefix>\_ali1\_psRadial\_1.pdf} and check that the theoretical CTF estimate (green) matches the radial average of the power spectrum of the tilt-series (black). Note that the amplitude doesn't matter here, the phase on the other hand, does.
    \item If they don't match, it is likely that you will need to adjust the \code{defEstimate} and \code{defWindow} parameters. Open \code{fixedStacks/ctf/*\_ccFIT.pdf}, which plots the cross-correlation score as a function of defocus. There is often an obvious correct peak, smoothly rising and falling. If you don't see this peak, try to change the sampled defoci with \code{defEstimate} $\pm$\code{defWindow} and re-run \code{ctf estimate}
\end{enumerate}

\begin{note}For a full description of the outputs generated by \code{ctf estimate}, you should refer to section \myref{sec:algo:defocus_estimate}.
\end{note}