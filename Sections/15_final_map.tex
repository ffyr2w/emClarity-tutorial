\section{Final reconstruction} \label{sec:final_map}

\subsection{Objectives}

This step consist into reconstructing the final reconstruction by combining the two half-set. {\emClarity} offers two possibilities.

The first possibility is to calculate the final reconstruction from the two subtomogram averages (one per FSC group), within {\emClarity}. Briefly, the half-maps are reconstructed as described in section \ref{sec:algo:avg} and the FSC is calculated, as well as the transformation between the two maps. Then, the particles from the second FSC groups are aligned to the first group, using the aforementioned transformation, while they are being re-extracted. The two aligned maps are then combined and filtered using the FSC calculated during the first reconstruction.

The second possibility is to calculate the reconstruction using {\cisTEM}. In this case, {\emClarity} reprojects the 3D coordinates of the particles in 2D, similarly to section \ref{sec:algo:tomoCPR:reproject_coords}. A {\cisTEM} STAR file is created, containing, for each particle and for each view of the tilt-series, its $x$ and $y$ position, rotation, defocus, pre- and post-exposure, etc. {\cisTEM} will then calculate an initial reconstruction using its \code{reconstruct3d} program, then refine it using \code{refine3d} (note that the $\phi,\ \theta,\ \psi$ angles are not refined) and then finally calculates with \code{reconstruct3d} the final reconstruction using this refinement.

\subsection{Parameters}

This step requires the exact same parameters as the subtomogram averaging step (table \ref{param:avg}, from section \ref{sec:avg}). The only difference is in the \code{fsc\_bfactor}, as explained in table \ref{param:avg}.

If you use {\cisTEM} to reconstruct the final map, only the following parameters are used: \code{subTomoMeta}, \code{PIXEL\_SIZE}, \code{particleRadius}, \code{VOLTAGE}, \code{Cs}, \code{AMPCONT}, \code{Ali\_mRadius} and \code{particleMass}.


\subsection{Run}

\subsubsection{With {\emClarity}}

First, you should start a new cycle by reconstructing the two half-maps and calculate the FSC:
\begin{lstlisting}
>> emClarity avg <param.m> <cycle_nb> RawAlignment
\end{lstlisting}
Then, the second FSC group will be re-extracted while being aligned to the first group. Finally, the two maps are combined and filtered using the FSC we just calculated.
\begin{lstlisting}
>> emClarity avg <param.m> <cycle_nb> FinalAlignment
\end{lstlisting}
This generates one filtered final reconstruction for every B-factor specified in \code{fsc\_bfactor}.

\subsubsection{With {\cisTEM}}
To calculate the final reconstruction with {\cisTEM}, run the following command:
\begin{lstlisting}
>> emClarity reconstruct <param.m> <cycle_nb> <prefix> <symmetry> <max_exposure>
\end{lstlisting}
where \code{<prefix>} is the prefix that will be added to every output generated by {\cisTEM}. \code{<symmetry>} is the symmetry to use for the reconstruction and should corresponds to the \code{symmetry} parameter in table \ref{param:avg}. \code{<max\_exposure>} is the maximum exposure, in e/\si{\angstrom}\textsuperscript{2}. Any images with more exposure that this value will be excluded from the reconstruction.

The scripts used to call {\cisTEM} are saved in the project directory:
\begin{enumerate}
    \item \code{<prefix>\_ref.sh} is calculating the first reconstruction (\code{<prefix>\_refFilt.mrc}) using the series of extracted particles (\code{<prefix>.mrc}) and the corresponding STAR file (\code{<prefix>.star}), both generated by {\emClarity}. The FSC is saved in \code{<prefix>\_stats.txt}.
    
    \item \code{<prefix>\_ref.sh} is then refining the alignment (only translations) and the statistics using the first reconstruction. The updated STAR file is saved as \code{<prefix>\_refined.star}.
    
    \item \code{<prefix>\_ref2.sh} is calculating the final reconstruction (\code{<prefix>\_refFilt\_refined.mrc}) using the updated STAR file. The FSC is saved in \code{<prefix>\_stats\_refined.txt}.
\end{enumerate}
