\section{Picking} \label{sec:picking}

\subsection{Objectives}

It's time to pick the particles, i.e. the subtomograms. There are many ways to pick particles, but they usually all rely on the tomograms. Each particle can be described by its $x,\ y,\ z$ coordinates and $\phi,\ \theta,\ \psi$ Euler angles. {\emClarity} has a template matching routine that can pick the subtomograms for you, but it requires a template.

\subsection{Parameters}

\input{Figures_Tables/08_parameters}

\subsection{Run} \label{sec:picking:run}

\subsubsection{Preparing the template}
Before running \code{templateSearch}, you need to prepare a template. This template should have the same pixel size as the \code{PIXEL\_SIZE} parameter. It doesn't need to be low-pass filter, as {\emClarity} will do it internally. If you want to re-scale a map, you can run:
\begin{lstlisting}
>> emClarity rescale <in> <out> <inPixel> <OutPixel> <method>
\end{lstlisting}
\code{<in>} and \code{<out>} are the name of your template and the output name of the re-scaled template, respectively. \code{<inPixel>} is the pixel size of your template and \code{<OutPixel>} is the desired pixel size. \code{<method>} can be ``GPU'' or ``cpu''.


\begin{note}We do provide a \href{https://github.com/bHimes/emClarity}{template} for this tutorial, but any 70S ribosome map should work.
\end{note}

\subsubsection{Generating the tomograms}

The tomograms use for the template matching are CTF multiplied as described in section \ref{sec:ctf_3d} and \ref{sec:algo:ctf_3d}. To generate them, simply run:
\begin{lstlisting}
>> emClarity ctf 3d <param> templateSearch
\end{lstlisting}
This will generate a tomogram for every subregion defined in the \code{recon/*.coords} files (table \ref{tab:recon_coords}).

\subsubsection{Template matching}

The \code{templateSearch} routine has the following signature:
\begin{lstlisting}
>> emClarity templateSearch <param> <prefix> <region> <template> <symmetry> <GPU>
\end{lstlisting}
\code{<param>} is the name of the parameter file, \code{<prefix>} is the base-name of the tilt-series in \code{<projectDir>/aliStacks} to process. \code{<region>} is the number of the sub-region to process (see section \ref{sec:subregions}). \code{<symmetry>} is not used but kept for backward compatibility. The \code{symmetry} parameter specified in the parameter file overrides whatever is entered on the command line. \code{<GPU>} is the GPU ID to use (starting from 1).

For example, to run \code{templateSearch} on the first tilt-series of the tutorial, where we defined 2 sub-regions:
\begin{lstlisting}
# First region
>> emClarity templateSearch param.m tilt1 1 template.mrc C1 1
# Second region
>> emClarity templateSearch param.m tilt1 2 template.mrc C1 1
\end{lstlisting}

\subsection{Outputs}

The primary goal now is to remove false positives due to strong homogeneous features like carbon edges, membranes, or residual gold beads. The template matching produces a ``cumulative correlation'' map, which can be opened alongside a 3d model of the selected peaks.

In \code{<projectDir>/convmap\_wedgeType\_2\_bin<X>}, with \code{<X>} equal to \code{Tmp\_sampling}:
\begin{itemize}
    \item To look at the 3d IMOD model containing the coordinates of the selected particles, you can open the model with \code{3dmodv}. However, if your particles aren't organized in a lattice, it is quite difficult to do anything with this.
    \item Open \code{<prefix>\_<region>\_bin<X>\_convmap.mrc} overlapped with \code{<prefix>\_<region>\_bin<X>.mod} to look and remove particles. Another possibility is to use the binned tomogram in \code{cache/<prefix>\_<region>\_bin<X>.rec}.
\begin{lstlisting}
3dmod <*>_convmap.mrc <*>.mod
# or
3dmod ../cache/<*>.rec <*>.mod
\end{lstlisting}
    \item You can always change the sampling, the angular search, the template or the threshold and re-run \code{templateSearch}, if you are not satisfied with the results. If you want to change the sub-region coordinates, change the boundaries in \code{../bin10/<prefix>\_bin10.mod} and re-run the \code{recScrip2.sh} script as explained in section \ref{sec:subregions}.
    \item TODO Remove neighbours
    \item TODO Constrains
\end{itemize}

This directory cannot be seen by emClarity as it currently is. You will need to rename it to \code{<projectDir>/convmap} before going to the next step.

\begin{note}For a full description of the outputs generated by \code{templateSearch}, you should refer to section \myref{sec:algo:picking}.
\end{note}

\begin{note}Changing the contours coordinates or adding new contours in the \code{.mod} file has no effect. You can only remove contours. See section \myref{sec:init} for more details.
\end{note}

\begin{note}The \code{wedgeType\_2} prefix comes from the an old version of emClarity and indicates the type of missing wedge mask to apply to the tomogram and the template before computing the cross-correlation scores. This parameter is no longer used.
\end{note}

\subsection{Import particles from another software} \label{sec:picking:import}

If you decide to use another software to pick your particles, you can still import them into {\emClarity}. In this case, you would need to create your own \code{.csv} and \code{.mod} files (see table \ref{tab:csv}). These files are relative to the sub-regions, which should still be defined as described in section \ref{sec:subregions}. If your coordinates are relative to the entire field of view, you can either define the entire field of view as your sub-regions or you can subtract the $x_{min}$, $y_{min}$ and $z_{min}$ of the sub-regions you defined in section \ref{sec:subregions} to your coordinates. As specified in table \ref{tab:csv}, the coordinates origin is at the lower left corner (at least as visualized in \code{3dmod}). Of course, you should still run \code{ctf estimate} (section \ref{sec:defocus_estimate}) before going to the next section.